window.qmcomp={pageMax:2,pageNumber:1,pageDisplay:"grid"},qmcomp.siteVersion="20240828",qmcomp.init=function(){njt.log("Initialising message composer"),qmcomp.writingTimer,qmcomp.writingWaitTime=500,njt.snip.setCaseSensitive(!0),qmcomp.load_data(),qmcomp.currentTemplate="",qmcomp.create_interface(),qmcomp.create_page1content(),qmcomp.set_page(1),njt.log("Initialised message composer")},njt.event.queue.pageloaded.push(function(){qmcomp.init()}),qmcomp.create_interface=function(){let r={t:"div",i:"page1",c:"gd-cont"},_={t:"div",i:"page1form",c:"gd-l4"},n={t:"div",i:"page1preview",c:"gd-l8"},y={t:"pre",i:"page1previewbox",a:{"snip-id":"page1preview"},h:"Preview goes here"},f={t:"textarea",i:"page1copyinput",a:{name:"page1copyinput",rows:0,cols:0,style:"display:none"}},i={t:"div",i:"page1buttons",c:"gd-s12"},u={t:"button",a:{onclick:"window.njt.event.eventHandler(event)",njteventclick:"displayPage2"},h:"Fill in variables",c:"qmc-btn"},d={t:"button",a:{onclick:"window.njt.event.eventHandler(event)",njteventclick:"resetPage1"},h:"Reset template",c:"qmc-btn"},p={t:"button",a:{onclick:"window.njt.event.eventHandler(event)",njteventclick:"copyPreview"},h:"Copy template",c:"qmc-btn"},e={t:"div",i:"page2",c:"gd-cont"},c={t:"div",i:"page2form",c:"gd-l4"},a={t:"div",i:"page2preview",c:"gd-l8"},h={t:"pre",i:"page2previewbox",h:"Preview goes here"},m={t:"textarea",i:"page2copyinput",a:{name:"page2copyinput",rows:0,cols:0,style:"display:none"}},o={t:"div",i:"page2buttons",c:"gd-s12"},l={t:"button",a:{onclick:"window.njt.event.eventHandler(event)",njteventclick:"displayPage1"},h:"Modify template",c:"qmc-btn"},g={t:"button",a:{onclick:"window.njt.event.eventHandler(event)",njteventclick:"resetPage2"},h:"Reset variables",c:"qmc-btn"},v={t:"button",a:{onclick:"window.njt.event.eventHandler(event)",njteventclick:"copyPreview"},h:"Copy message",c:"qmc-btn"},b={t:"button",c:"qmc-btn",a:{onclick:"window.njt.event.eventHandler(event)",njteventclick:"openSettings"},h:"Settings"},j={t:"button",c:"qmc-btn",a:{onclick:"window.njt.event.eventHandler(event)",njteventclick:"openAbout"},h:"About"};i.e=[u,d,p],n.e=[y,f],r.e=[_,n,i],o.e=[l,g,v],a.e=[h,m],e.e=[c,a,o];let s=njt.dom.getElementById("contentwrapper");s.appendChild(njt.element.buildElementTree(r)),s.appendChild(njt.element.buildElementTree(e));let t=njt.dom.getElementById("page-headingbuttons");t.appendChild(njt.element.buildElementTree(b)),t.appendChild(njt.element.buildElementTree(j))},qmcomp.create_sampledata=function(){let n=function(e,t){let n={};return n.h=e,n.a=t,n},c=function(e,t){let n={};return n.h=e,n.l=t,n},e=function(e,t=0){let n={};return n.s=e,n.r=t,n},a={},t={},r={},i={};t.greeting=n("Greeting",[{v:"Hi {:Name:},",h:"Hi {:Name:}"},{v:"Hello {:Name:},",h:"Hello {:Name:}"},{v:"Good {:TimeOfDay:} {:Name:},",h:"Good {:TimeOfDay:} {:Name:}"}]),t.thankyou=n("Thank you",[{v:"Thank you for {:YourThanks:}.",h:"...for {:YourThanks:}"},{v:"Thank you for {:YourThanks:} and {:ExtraThanks:}.",h:"...for {:YourThanks:} and {:ExtraThanks:}"}]),t.iwill=n("I will",[{v:"I will update you on {:Subject:} {:Timeframe:}.",h:"...update on {:Subject:}, {:Timeframe:}"},{v:"I will await {:Roadblock:} and follow up of no response by {:Timeframe:}.",h:"...await {:Roadblock:}, follow up {:Timeframe:}"},{v:"I will {:Action:} and update you {:Timeframe:}.",h:"...{:Action:}, update {:Timeframe:}"}]),t.triedcall=n("Tried calling",[{v:"I tried calling you on {:Number:} but you were unavailable.",h:"on {:Number:}"},{v:"I tried calling you on {:Number:} but you were unavailable so I left a voicemail.",h:"on {:Number:}, left a voicemail"},{v:"I tried calling you on {:Number:} but spoke with {:Person:} who {:CallSummary:}.",h:"on {:Number:}, spoke with {:Person:} who {:CallSummary:}"}]),t.callback=n("Call back",[{v:"I will try calling you back {:Timeline:}.",h:"I will try call you back {:Timeline:}"},{v:"Please call me back when you are free.",h:"Please call me"}]),t.extramessage=n("Extra details",[{v:"{:ExtraDetails:}",h:"Yes"}]),t.signoff=n("Sign off",[{v:"Regards,",h:"Regards"},{v:"Kind regards,",h:"Kind regards"},{v:"Best wishes,",h:"Best wishes"},{v:"Cheers,",h:"Cheers"}]),t.yourname=n("Your name",[{v:"{:YourName:}.",h:"{:YourName:}"}]),i.timeofday={i:3,h:"Time of the day",a:[{v:"Morning",h:"Morning"},{v:"Afternoon",h:"Afternoon"},{v:"Evening",h:"Evening"}]},i.name={i:1,h:"Name of client"},i.extradetails={i:1,r:4,h:"Extra details"},i.yourthanks={i:2,h:"Thanks for",a:[{v:"your time",h:"your time"},{v:"the call",h:"the call"},{v:"the email",h:"the email"},{v:"the message",h:"the message"}]};let s=[];s.push(e("greeting",2)),s.push(e("thankyou",1)),s.push(e("iwill",0)),s.push(e("extramessage",0)),s.push(e("signoff",2)),s.push(e("yourname",2));let o=[];return o.push(e("greeting",2)),o.push(e("triedcall",2)),o.push(e("callback",2)),o.push(e("extramessage",0)),o.push(e("signoff",2)),o.push(e("yourname",2)),r.callsample=c("Post call sample",s),r.triedcallsample=c("Tried calling sample",o),a.sections=t,a.templates=r,a.variables=i,a},qmcomp.verify_data=function(e){let t={h:njt.types.STRING,a:njt.types.ARRAY},n={v:njt.types.STRING,h:njt.types.STRING},s={h:njt.types.STRING,l:njt.types.ARRAY},o={s:njt.types.STRING,r:njt.types.NUMBER},i={i:njt.types.NUMBER},a={v:njt.types.STRING,h:njt.types.STRING};if(njt.js.typeOf(e)!=njt.types.OBJECT)return!1;if(njt.js.typeOf(e.sections)!=njt.types.OBJECT)return!1;if(njt.js.typeOf(e.templates)!=njt.types.OBJECT)return!1;for(let s in e.sections){if(!njt.js.validate(e.sections[s],t))return!1;for(let t=0;t<e.sections[s].a.length;t++)if(!njt.js.validate(e.sections[s].a[t],n))return!1}for(let t in e.templates){if(!njt.js.validate(e.templates[t],s))return!1;for(let n=0;n<e.templates[t].l.length;n++){if(!njt.js.validate(e.templates[t].l[n],o))return!1;if(e.sections[e.templates[t].l[n].s]==void 0)return!1}}if(njt.js.typeOf(e.variables)==njt.types.OBJECT)for(let t in e.variables){if(!njt.js.validate(e.variables[t],i))return!1;let n=e.variables[t].i,s=njt.js.typeOf(e.variables[t].h),o=njt.js.typeOf(e.variables[t].v),r=njt.js.typeOf(e.variables[t].l),c=njt.js.typeOf(e.variables[t].a);if(s!=njt.types.STRING&&s!=njt.types.UNDEFINED&&s!=njt.types.NULL)return!1;if(o!=njt.types.STRING&&o!=njt.types.UNDEFINED&&o!=njt.types.NULL)return!1;if(n==1)if(r==njt.types.NUMBER){if(e.variables[t].r<1)return!1}else if(r!=njt.types.UNDEFINED&&r!=njt.types.NULL)return!1;if(n==2||n==3)if(c==njt.types.ARRAY){for(let n=0;n<e.variables[t].a.length;n++)if(!njt.js.validate(e.variables[t].a[n],a))return!1}else if(c!=njt.types.UNDEFINED&&c!=njt.types.NULL)return!1}return!0},qmcomp.load_data=function(){let t=localStorage.getItem("dataString"),e=null;if(t)try{e=JSON.parse(t),qmcomp.verify_data(e)||(e=qmcomp.create_sampledata())}catch{e=qmcomp.create_sampledata()}else e=qmcomp.create_sampledata();qmcomp.data=e,qmcomp.save_data()},qmcomp.save_data=function(){localStorage.setItem("dataString",JSON.stringify(qmcomp.data))},qmcomp.set_page=function(e){qmcomp.pageNumber=e%qmcomp.pageMax,qmcomp.pageNumber==0&&(qmcomp.pageNumber=qmcomp.pageMax),qmcomp.display_page(),qmcomp.focus_page()},qmcomp.set_pagenext=function(){qmcomp.set_page(qmcomp.pageNumber+1)},qmcomp.set_pageprevious=function(){qmcomp.set_page(qmcomp.pageNumber-1)},qmcomp.display_page=function(){for(let e=1;e<=qmcomp.pageMax;e++)e==qmcomp.pageNumber?njt.dom.getElementById("page"+e).style.display=qmcomp.pageDisplay:njt.dom.getElementById("page"+e).style.display="none";qmcomp["update_page"+qmcomp.pageNumber]()},qmcomp.focus_page=function(){let e="cat";if(qmcomp.pageNumber==1?e="templates-input":qmcomp.pageNumber==2&&(e="snip0-input"),e!=""){let t=njt.dom.getElementById(e);t!=null&&t.focus()}},qmcomp.update_page1=function(){qmcomp.update_page1preview()},qmcomp.update_page2=function(){qmcomp.create_page2form(),qmcomp.update_page2preview()},qmcomp.create_page1content=function(){qmcomp.create_page1templatedropdown(),qmcomp.create_page1form()},qmcomp.create_page1templatedropdown=function(){let e={t:"njt/form",i:"templateSelect",e:[],a:{onchange:"window.njt.event.eventHandler(event)"}},t=!0;templateValues=[];for(let e in qmcomp.data.templates){t&&(qmcomp.currentTemplate=e,t=!1);let n={v:e,h:qmcomp.data.templates[e].h};templateValues.push(n)}templateDropdown={t:"njt/form/select",i:"templates",c:"gd-s12",l:"Templates",o:templateValues},e.e.push(templateDropdown);let n=njt.formbuilder.generate(e);njt.dom.getElementById("page1form").innerHTML="",njt.dom.getElementById("page1form").appendChild(n),njt.dom.getElementById("templates-input").setAttribute("njteventchange","templateChange")},qmcomp.create_page1form=function(){let e={t:"njt/form",i:"templateOptions",e:[],a:{onchange:"window.njt.event.eventHandler(event)"}},t=qmcomp.data.templates[qmcomp.currentTemplate].l,n=t.length;for(let s=0;s<n;s++){let o=t[s],a=qmcomp.data.sections[o.s],i=[...a.a];o.r==0?i.unshift({v:"",h:""}):o.r==1&&i.push({v:"",h:""}),e.e.push({t:"njt/form/select",i:"section"+s,c:"gd-s12",l:a.h,o:i})}let s=njt.formbuilder.generate(e),o=njt.dom.getElementById("templateOptions");o==null?njt.dom.getElementById("page1form").appendChild(s):o.outerHTML=s.outerHTML;for(let e=0;e<n;e++){let t=njt.dom.getElementById("section"+e+"-input");t.setAttribute("njteventchange","updatePage1Preview")}},qmcomp.create_page2form=function(){qmcomp.currentsnips=njt.snip.examineById("page1preview");let e={t:"njt/form",e:[],a:{onchange:"window.njt.event.eventHandler(event)"}},t=qmcomp.currentsnips.length;for(let i=0;i<t;i++){let o=qmcomp.currentsnips[i],n=null,s={t:"njt/form/input",i:"snip"+i,c:"gd-s12",l:o,p:""};njt.js.typeOf(qmcomp.data.variables)==njt.types.OBJECT&&(njt.js.typeOf(qmcomp.data.variables[o])==njt.types.OBJECT?n=qmcomp.data.variables[o]:njt.js.typeOf(qmcomp.data.variables[o.toLowerCase()])==njt.types.OBJECT&&(n=qmcomp.data.variables[o.toLowerCase()])),njt.js.typeOf(njt.snip.valueMap[o])!==njt.types.UNDEFINED?njt.snip.valueMap[o]!=""&&(s.v=njt.snip.valueMap[o]):n!==null&&njt.js.typeOf(n.v)==njt.types.STRING&&(s.v=n.v),n!==null&&(njt.js.typeOf(n.h)==njt.types.STRING&&(s.l=n.h),n.i==2?(s.t="njt/form/datalist",s.o=n.a):n.i==3?(s.t="njt/form/select",s.o=n.a):njt.js.typeOf(n.r)==njt.types.NUMBER&&n.r>0&&(s.t="njt/form/textarea",s.r=n.r)),e.e.push(s)}let n=njt.formbuilder.generate(e);njt.dom.getElementById("page2form").innerHTML="",njt.dom.getElementById("page2form").appendChild(n)},qmcomp.update_templatechange=function(e=!1){let t=njt.dom.getElementById("templates-input").value;(qmcomp.currentTemplate!==t||e)&&(qmcomp.currentTemplate=t,qmcomp.create_page1form(),qmcomp.update_page1preview())},qmcomp.update_page1preview=function(){let e="",n=qmcomp.data.templates[qmcomp.currentTemplate].l.length,t=!0;for(let s=0;s<n;s++){let o=njt.dom.getElementById("section"+s+"-input").value;o!==""&&(t?t=!1:e+=`

`,e+=o)}njt.dom.getElementById("page1previewbox").innerHTML=e},qmcomp.update_page2preview=function(){let e=qmcomp.currentsnips.length;for(let t=0;t<e;t++)njt.snip.valueMapPush(qmcomp.currentsnips[t],njt.dom.getElementById("snip"+t+"-input").value);njt.dom.getElementById("page2previewbox").innerHTML=njt.snip.processString(njt.dom.getElementById("page1previewbox").innerHTML)},qmcomp.reset_snipvariables=function(){njt.snip.valueMapClear(),qmcomp.set_page(2)},qmcomp.reset_page=function(){qmcomp.pageNumber==1?qmcomp.update_templatechange(!0):qmcomp.pageNumber==2&&qmcomp.reset_snipvariables(),qmcomp.focus_page()},qmcomp.reset_app=function(){njt.snip.valueMapClear(),qmcomp.update_templatechange(!0),qmcomp.set_page(1)},njt.event.addFunction("templateChange",function(){qmcomp.update_templatechange()}),njt.event.addFunction("updatePage1Preview",function(){qmcomp.update_page1preview()}),njt.event.addFunction("updatePage2Preview",function(){qmcomp.update_page2preview()}),njt.event.addFunction("displayPage1",function(){qmcomp.set_page(1)}),njt.event.addFunction("displayPage2",function(){qmcomp.set_page(2)}),njt.event.addFunction("resetPage1",qmcomp.reset_page),njt.event.addFunction("resetPage2",qmcomp.reset_page),qmcomp.display_modalerror=function(e){let t=njt.dom.getElementById("modalErrorBox");t.textContent=e,t.style.display="block"},qmcomp.close_modal=function(){njt.modal.closeNow()},njt.modal.openFunctions.aboutOpen=function(){njt.modal.openNow("aboutModal");let t=njt.dom.getElementById("aboutVersion");t.textContent="Version: "+qmcomp.siteVersion},njt.modal.openFunctions.datadefinitionOpen=function(){njt.modal.openNow("datadefinitionModal");let t=njt.dom.getElementById("modalErrorBox");t.style.display="none",t.textContent="";let n=null;try{n=JSON.stringify(qmcomp.data,null,4),njt.dom.getElementById("page1formdef").value=n}catch{return!1}},njt.modal.closeFunctions.datadefinitionClose=function(e){if(njt.log("In custom close function for modal triggered by element with id: "+e.target.id),e.target.id=="modalSaveButton"){let e=null;try{e=JSON.parse(njt.dom.getElementById("page1formdef").value),qmcomp.verify_data(e)?(qmcomp.data=e,qmcomp.save_data(),qmcomp.close_modal(),qmcomp.create_page1templatedropdown(),qmcomp.create_page1form(),qmcomp.close_modal(),qmcomp.set_page(1)):qmcomp.display_modalerror("Form definition did not pass validation")}catch{qmcomp.display_modalerror("Form definition not valid JSON")}}else e.target.id=="modalResetButton"?(qmcomp.data=qmcomp.create_sampledata(),qmcomp.save_data(),qmcomp.create_page1templatedropdown(),qmcomp.create_page1form(),qmcomp.close_modal(),qmcomp.set_page(1)):(qmcomp.close_modal(),qmcomp.focus_page())},njt.event.addFunction("openAbout",function(e){njt.modal.open("aboutModal",e)}),njt.event.addFunction("openSettings",function(e){njt.modal.open("datadefinitionModal",e)}),njt.event.addFunction("tryCloseModal",function(e){njt.modal.close(e)}),njt.event.addFunction("copyPreview",function(){let n="",s="";qmcomp.pageNumber==1?(n="page1copyinput",s="page1previewbox"):qmcomp.pageNumber==2&&(n="page2copyinput",s="page2previewbox");let t=document.getElementById(n);t.style.display="block",t.value=document.getElementById(s).innerHTML,t.select(),t.setSelectionRange(0,t.value.length),document.execCommand("copy"),t.style.display="none"}),qmcomp.trackWritingInputTime=function(){clearTimeout(qmcomp.writingTimer),qmcomp.writingTimer=setTimeout(()=>{qmcomp.pageNumber==2&&qmcomp.update_page2preview()},qmcomp.writingWaitTime)},document.body.addEventListener("keydown",function(e){e.ctrlKey&&e.shiftKey&&(e.keyCode==65?e.returnValue=!1:e.keyCode==67?e.returnValue=!1:e.keyCode==82?e.returnValue=!1:e.keyCode==83?e.returnValue=!1:e.keyCode==90?e.returnValue=!1:e.keyCode==188?e.returnValue=!1:e.keyCode==190?e.returnValue=!1:e.keyCode==191&&(e.returnValue=!1))},!1),document.body.addEventListener("keyup",function(e){qmcomp.trackWritingInputTime(),e.ctrlKey&&e.shiftKey&&(e.keyCode==65?(njt.event.funct.openAbout(),e.returnValue=!1):e.keyCode==67?(qmcomp.update_page2preview(),njt.event.funct.copyPreview(),e.returnValue=!1):e.keyCode==82?(qmcomp.reset_app(),e.returnValue=!1):e.keyCode==83?(njt.event.funct.openSettings(),e.returnValue=!1):e.keyCode==90?(qmcomp.reset_page(),e.returnValue=!1):e.keyCode==188?(qmcomp.set_pageprevious(),e.returnValue=!1):e.keyCode==190?(qmcomp.set_pagenext(),e.returnValue=!1):e.keyCode==191&&(qmcomp.focus_page(),e.returnValue=!1))},!1)